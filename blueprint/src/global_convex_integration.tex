\chapter{Global theory of open and ample relations}
\label{chap:global}

\section{Preliminaries}

\subsection{Localisation data}%
\label{sub:localisation_data}

In order to conveniently globalize the theory of the previous chapter, we'll
need a number of constructions and lemmas. By definition, manifolds are covered
by open sets that are diffeomorphic to open sets of vector spaces. But for us it is
slightly more convenient to work with smooth open embeddings of whole vector spaces.
Here a smooth open embedding from a manifold $X$ to a manifold $Y$ is a smooth map
$φ : X → Y$ which is open and for which there is some smooth $ψ : φ(X) → X$ such that
$ψ ∘ φ = \Id$ and $φ ∘ ψ = \Id$.
Remember that a family of sets $V_i$ in a topological space $X$ is locally finite if
every point of $X$ has a neighborhood that intersects only finitely many $V_i$.
Note that in this whole text, every manifold is paracompact by definition. In
particular their topology are metrizable and we will arbitrarily fix a
compatible distance function on every manifold.

\begin{definition}
  \label{def:update}
  \lean{open_smooth_embedding.update}
  \leanok
  Given smooth open embeddings $φ : X → M$ and $ψ : Y → N$, the update of a map
  $f : M → N$, using a map $g : X → Y$
  is the map from $M$ to $N$ sending $m$ to $ψ ∘ g ∘ φ⁻¹(m)$ if
  $m ∈ φ(X)$ and $f(m)$ otherwise.
\end{definition}

\begin{lemma}
  \label{lem:updating}
  \uses{def:update}
  \lean{open_smooth_embedding.nice_update_of_eq_outside_compact}
  \leanok
  Let $φ : X → M$ and $ψ : Y → N$ be smooth open embeddings. Let $K$ be a
  compact set in $X$. Let $f : M → N$ be a smooth map such
  that $f(φ(X)) ⊂ ψ(Y)$. Let $g : X → Y$ be a smooth map which agrees with
  $ψ⁻¹∘f∘φ$ outside of $K$. Denote by $f'$ the update of $f$ using $g$.
  \begin{itemize}
    \item
      $f'$ is a smooth map from $M$ to $N$.
    \item
      For every continuous function $ε : M → ℝ_{> 0}$, there is some positive
      number $η$ such that, if $∀ x, d(g(x), ψ⁻¹∘f∘φ(x)) < η$ then
      $∀ m ∈ M, d(f(m), f'(m)) < ε(m)$.
  \end{itemize}
\end{lemma}

\begin{proof}
  \leanok
  In order to prove smoothness of $f'$, note that $M = φ(X) ∪ φ(K)^c$. Both
  those sets are open and $f'$ coincide with $ψ ∘ g ∘ φ⁻¹$ on the first one and
  $f$ on the second one.

  Let $ε$ be a positive continuous function on $M$. Since $K$ is compact, we get
  a positive number $ε₀$ such that $ε(m) ≥ ε₀$ for each $m$ in $K$. We denote by
  $K₁$ the closed $1$-thickening of $ψ⁻¹∘f∘φ(K)$ in $F$. This is a compact set
  so $ψ$ is uniformly continuous on $K₁$ and we get a positive $τ$ such that
  for all $x$ and $y$ in $K₁$, $d(x, y) < τ ⇒ d(ψ(x), ψ(y)) < ε₀$.

  We now prove that $η = \min(τ, 1)$ is suitable. Assume that
  $∀ x, d(g(x), ψ⁻¹∘f∘φ(x)) < η$. Let $m$ be a point in $M$. If $m$ isn't in
  $φ(K)$ then $f'(m) = f(m)$ and in particular $d(f(m), f'(m)) < ε(m)$. Now
  assume that $m = φ(x)$ for some $x$ in $K$. By assumption $d(g(x), ψ⁻¹∘f∘φ(x)) < η$.
  In particular $d(g(x), ψ⁻¹∘f∘φ(x)) < 1$ hence $g(x)$ is in $K₁$. Since
  $ψ⁻¹∘f∘φ(x)$ is also in $K₁$ and $d(g(x), ψ⁻¹∘f∘φ(x)) < τ$, we get
  $d(ψ∘ g(x), ψ ∘ ψ⁻¹∘f∘φ(x)) < ε₀$. This precisely means that
  $d(f'(m), f(m)) < ε₀$. Since $m$ is in $K$, this is less than $ε(m)$.
\end{proof}

\begin{lemma}
  \label{lem:nice_atlas}
  \lean{nice_atlas}
  \leanok
  Let $M$ be a manifold modelled on the normed space $E$ and $(V_j)_{j ∈ J}$
  a cover of $M$ by open sets. There exists a countable set $ι$ and
  a family of smooth open embeddings $φ : ι × E → M$ such that
  \begin{itemize}
    \item for each $i$ there is some $j$ such that $φ_i(E) \subseteq V_j$,
    \item $i ↦ φ_i(E)$ is a locally-finite collection of sets in $M$,
    \item $⋃_i φ_i(B_E(0, 1)) = M$ where $B_E(0, 1)$ is the open unit ball in $E$.
  \end{itemize}
\end{lemma}

\begin{proof}
  \leanok
  The proof is a standard compact-exhaustion argument.
  Let $K_0, K_1, K_2, \ldots $ be a compact exhaustion of $M$ and define:
  \begin{align*}
    C_n &= K_{n+2} \smallsetminus K_{n+1}^o,\\
    U_n &= K_{n+3}^o \smallsetminus K_n.
  \end{align*}
  Thus:
  \begin{itemize}
    \item $C_n$ is compact,
    \item $U_n$ is open,
    \item $C_n \subseteq U_n$,
    \item $\bigcup_n C_n = M$,
    \item $U_n \cap U_m = \emptyset$ if $|n - m| > 2$.
  \end{itemize}
  For any $y \in E$ and $r > 0$, fix a smooth diffeomorphism $f_{y,r} : E \simeq B_E(y, r)$ such
  that $f_{y,r}(0) = y$.
  For each $n$ and $x \in C_n$, let $\psi_x$  be a smooth chart mapping an open
  neighbourhood of $x$ to an open set of the model space $E$.
  Writing $y = \psi_x (x) \in E$, let:
  \begin{align*}
    B_{n, x} &= \psi_x^{-1} (B_E(y, r)),\\
    W_{n, x} &= \psi_x^{-1} (f_{y,r} (B_E (0, 1))),\\
  \end{align*}
  for some $r > 0$ (which may depend on $n$, $x$) sufficiently small that:
  \begin{itemize}
    \item $B_E(y, r)$ lies in the target of the chart $\psi_x$,
    \item $B_{n,x}$ is contained in $U_n$,
    \item $B_{n,x}$ is contained in $V_j$ for some $j$.
  \end{itemize}
  Note that $x \in W_{n,x}$. For each $n$, choose a finite subcovering of $C_n$ by
  $W_{n, x_1}, \ldots, W_{n, x_{l_n}}$ and define $\iota \subseteq ℕ \times M$ by:
  \begin{align*}
    \iota = \bigcup_n \{ (n, x_1), \ldots, (n, x_{l_n}) \} .
  \end{align*}
  Note that $\iota$ is countable and furthermore:
  \begin{itemize}
    \item for each $i \in \iota$, there is some $j$ such that $B_i \subseteq V_j$,
    \item $(B_i)_{i \in \iota}$ is locally-finite
    (indeed more is true: $B_i$ meets only finitely-many $B_{i'}$ for $i, i' \in \iota$
    since $B_{m, x} \cap B_{n, x'} = \emptyset$ if $|n - m| > 2$),
    \item $(W_i)_{i \in \iota}$ covers $M$.
  \end{itemize}
  Given $i = (n, x_j) \in \iota$, the required map $\phi_i : E \to M$ is just:
  \begin{align*}
    E \simeq B_E(y_j, r) \simeq B_{n,j} \subseteq M.
  \end{align*}
\end{proof}

\begin{definition}
  \label{def:localisation_data}
  \lean{localisation_data}
  \leanok
  Let $f : M → N$ be a continuous map between manifolds. A localisation data
  for $f$ is a tuple $(E, F, ι, ι', φ, ψ, j)$ where $E$ and $F$ are normed
  vector spaces, $ι$ is a countable set, $ι'$ is a set (that is
  morally also countable but that will play no role), $φ : ι × E → M$
  and $ψ : ι' × F → N$  are families of smooth open embeddings, and
  $j : ι → ι'$ such that:
  \begin{itemize}
    \item
      $⋃_i φ_i(B_E) = M$ where $B_E$ is the open unit ball in $E$,
      \item
      $⋃_i ψ_i(B_F) = N$ where $B_F$ is the open unit ball in $F$,
    \item
      $∀ i, f(φ_i(E)) ⊂ ψ_{j(i)}(B_F)$ where $B_F$ is the open unit ball in $F$,
    \item
      $i \mapsto ψ_i(F)$ is locally finite.
  \end{itemize}
  Such a tuple will be denoted by $(φ, ψ, j)$ for brevity.
\end{definition}

\begin{lemma}
  \label{lem:ex_localisation}
  \uses{def:localisation_data}
  \lean{std_localisation_data}
  \leanok
  Any continuous map between manifolds has some localisation data.
\end{lemma}

\begin{proof}
  \uses{lem:nice_atlas}
  \leanok
  The preceding lemma (applied to the trivial cover of $N$ by itself) gives a
  family of $ψ : ι' × F → N$ of open smooth embeddings that the images of
  $B_F$ cover $N$. We then apply this lemma again to the cover of $M$ given by all
  $f⁻¹(ψ_j(B_F))$.
\end{proof}

The general idea will be to apply the results of the previous chapters to
all the $ψ_{j(i)}⁻¹ ∘ f ∘ φ_i : E → F$ for some maps $f$. However we must be
careful that doing this for some $i$ does not ruin the setup for the next $i$.
This is easier to control using a distance function on the target manifold as
in \Cref{lem:localisation_stability} below. First we need a general lemma about
a single metric space (actually the formalized statement is stronger, it assumes
only closed sets instead of compact ones, but here we explain the easier proof
which is sufficient for our purposes).

\begin{lemma}
  \label{lem:stability_cover}
  \lean{metric.exists_continuous_real_forall_closed_ball_subset}
  \leanok
  In a metric space $X$, let $U : ι → \set{X}$ be a
  family of open subsets of $X$ and let $K : ι → \set{X}$ be a locally-finite
  family of closed subsets such that $K_i ⊂ U_i$ for all $i$. There exists a continuous
  function $δ : X → ℝ_{> 0}$ such that:
  \[
    ∀ x\, x',\; ∀ i, \left[x ∈ K_i \text{ and } d(x, x') < δ(x)\right] ⇒ x' ∈ U_i.
  \]
\end{lemma}

\begin{proof}
  \leanok
  We first note that, for any given $i$, compactness of $K$ and openness of
  $V_i$ give a positive number $δ_i$ such that the $δ_i$-neighborhood of $K_i$
  is contained in $V_i$. We now prove that solutions exist locally. Let $x$ be
  any point in $X$. From the local finiteness assumption, we get a neighborhood
  $U$ of $x$ such that $\{i | U ∩ V_i ≠ ∅\}$ is finite. The constant function
  with value the minimum of the corresponding $δ_i$ is a solution on $U$. Since
  the condition we put on $δ$ is convex, we can glue those local solutions using
  a partition of unity.
\end{proof}

\begin{lemma}
  \label{lem:localisation_stability}
  \lean{localisation_stability}
  \leanok
  \uses{def:localisation_data}
  Let $f : M → N$ be a continuous map between manifolds, and let
  $(φ, ψ, i)$ be some localisation data for $f$. There exists a continuous
  positive function $ε : M → ℝ_{>0}$ such that:
  \[
    ∀ g : M → N, \big[∀ m,\; d(f(m), g(m)) < ε(m)\big] ⇒ ∀ i,\; g(φ_i(E)) ⊂ ψ_{j(i)}(F).
  \]
\end{lemma}
Note that, in the preceding lemma, the conclusion $g(φ_i(E)) ⊂ ψ_{j(i)}(F)$ is
weaker than the condition $f(φ_i(E)) ⊂ ψ_{j(i)}(B_F)$ that appears in the
definition of localisation data.

The condition $∀ m,\; d(g(m), f(m)) < ε(m)$ will be abbreviated $d(g, f) < ε$.

\begin{proof}
  \leanok
  \uses{lem:stability_cover}
  The preceding lemma applied to the family of open sets $ψ_j(F)$ and the
  family of compact sets $ψ_j(\overline{B_F})$ give a positive continuous
  function $δ : N → ℝ$ such that $ε = δ ∘ f$ is suitable. Indeed, assume
  $g : M → N$ satisfies $d(g, f) < ε$ and fix some $i$ and some $m ∈ φ_i(E)$.
  We know $f(m) ∈ ψ_{j(i)}(\overline{B_F})$ and our assumption on $g$ gives
  $d(g(m), f(m)) < δ(f(m))$. So the property of $δ$ ensures $g(m) ∈ ψ_{j(i)}(F)$.
\end{proof}

We now introduce a seemingly abstract definition, but its only goal is to treat
uniformly the case of $ℕ$ and finite sets $\{0, \dots, n\}$.

\begin{definition}
  \label{def:convenient_indexing}
  \leanok
  \lean{indexing}
  A convenient indexing set is a totally ordered set $ι$ equipped with
  maps $π : ℕ → ι$ and $σ : ι → ℕ$ such that $π$ is order preserving and
  $π ∘ σ = \Id$ (in particular $π$ is surjective).
\end{definition}

In the case $ι = ℕ$ we will use $π = σ = \Id$ while in the case
$ι = \{0, \dots, n-1\}$ we use the unique order-preserving retraction as $π$ and
the inclusion as $σ$.

\begin{lemma}
  \label{lem:loc_ultim_const}
  \lean{locally_finite.exists_forall_eventually_at_top_eventually_eq}
  \leanok
  Let $M$ a topological space and $Z$ a set.
  Let $f : ℕ × M → Z$ be a sequence of functions. If
  the family of sets $n ↦ \{x \;\|\; f_{n+1}(x) \ne f_n(x)\}$
  is locally finite then there exists $U : M → \set{M}$ and
  $n₀ : M → ℕ$ such that:
  \[
    ∀ x,\; U_x ∈ 𝓝_x \text{ and }
           ∀ n ≥ n₀(x),\; \rst{f_n}{U_x} = \rst{f_{n₀(x)}}{U_x}.
  \]
\end{lemma}

Note that the conclusion of above lemma ensures that the sequence $f_n$
converges pointwise and the limit inherits all local properties of the $f_n$
(such as continuity or differentiability when applicable).

\begin{proof}
  \leanok
  The local finiteness assumption provides a function $U : M → \set{M}$
  such that
  \[
    ∀ x,\; U_x ∈ 𝓝_x \text{ and }
    \{n \;|\; \{y \;|\;f_n(y) ≠ f_{n+1}(y)\} ∩ U_x ≠ ∅\} \text{ is
    finite}.
  \]
  For any $x$, we denote by $N_x$ the largest $n$ of the finite set mentioned
  above. By construction, $n₀ \co x ↦ N_x + 1$ is suitable.
\end{proof}

\subsection{Vector bundles operations}
\label{sec:vector_bundles_operations}

\begin{definition}
\label{def:pull_back_bundle}
\leanok
\lean{basic_smooth_vector_bundle_core.pullback}
For every bundle $p : E → B$ and every map $f \co B' → B$,
the pull-back bundle $f^*E → B'$ is defined by
$f^*E = \{(b', e) ∈ B' × E \;|\; p(e) = f(b')\}$ with
the obvious projection to $B'$.
\end{definition}

The case of vector bundles.

\begin{definition}
\label{def:hom_bundle}
\leanok
\lean{basic_smooth_vector_bundle_core.hom}
Let $E → B$ and $F → B$ be two vector bundles over some smooth manifold
$B$. The bundle $\Hom(E, F) → B$ is the set of linear maps from
$E_b$ to $F_b$ for some $b$ in $B$, with the obvious projection map.
\end{definition}

Set-theoretically, one can define $\Hom(E, F)$ as the set of subsets
$S$ of $E × F$ such that there exists $b$ such that $S ⊂ E_b × F_b$
and $S$ is the graph of a linear map. But the type theory formalization
will use other tricks here. The facts that really matter are listed in
\cref{lem:one_jet_extension_prop}.


\subsection{Jets spaces}

\begin{definition}
\label{def:one_jet_space}
\leanok
\lean{one_jet_bundle_core}
\uses{def:pull_back_bundle, def:hom_bundle}
Let $M$ and $N$ be smooth manifolds. Denote by
$p_1$ and $p_2$ the projections of $M × N$ to
$M$ and $N$ respectively.

The space $J^1(M, N)$ of $1$-jets of maps from $M$ to $N$ is
$Hom(p_1^*TM, p_2^*TN)$
\end{definition}

We will use notations like $(m, n, φ)$ to denote an element
of $J^1(M, N)$,
but one should keep in mind that $J^1(M, N)$ is not a product,
since $φ$ lives in $\Hom(T_mM, T_nN)$ which depends on $m$ and $n$.


\begin{definition}
\label{def:one_jet_extension}
\uses{def:one_jet_space}
\leanok
\lean{one_jet_ext}
The $1$-jet of a smooth map $f \co M → N$ is the map from
$m$ to $J^1(M, N)$ defined by $j^1f(m) = (m, f(m), T_mf)$.
\end{definition}

The composition of a section $\F \co M → J^1(M, N)$ with the projection
onto $N$ will sometimes be denoted by $\bs \F \co M → N$ and called the
base map of $\F$. For any $m$, $\F(m)_φ$ will denote the component of $\F(m)$
living in $\Hom(T_mM, T_{\bs\F(m)}N)$.

\begin{lemma}
\label{lem:one_jet_extension_prop}
\lean{smooth.one_jet_ext, one_jet_ext_proj}
\leanok
\uses{def:one_jet_extension}
For every smooth map $f \co M → N$,
\begin{enumerate}
  \item
    \label{lem:one_jet_smooth}\uses{def:one_jet_space, def:one_jet_extension}
    $j^1f$ is smooth
  \item
    \label{lem:one_jet_section}\uses{def:one_jet_space, def:one_jet_extension}
    $j^1f$ is a section of $J^1(M, N) → M$
  \item
    \label{lem:one_jet_zero_jet}\uses{def:one_jet_space, def:one_jet_extension}
    $j^1f$ composed with $J^1(M, N) → N$ is $f$.
\end{enumerate}
\end{lemma}

\begin{proof}
  \leanok
  Points 2 and 3 are obvious by construction.

  To show that $j^1f$ is smooth, suppose that $M$ is modelled over $E$ with charts
  $C_x : M \to E$ and coordinate change functions
  $C_{x,x'}=C_{x'}C_x^{-1} : E \to E$ and similarly let $C'_y$ be charts for $N$.
  By construction of the 1-jet bundle, we need to check that for each $x_0$ the map
  $$x\mapsto TC'_{f(x),f(x_0)}\circ T(C'_{f(x)}fC_x^{-1})\circ
    T_{C_{x_0}(x)}(C_{x_0,x}): M \to L(E,E)$$
  is smooth at $x_0$ (we occasionally omit the point where the tangent maps are taken).
  For $x$ close to $x_0$ the coordinate changes are smooth, so we can write
  \begin{align*}
  TC'_{f(x),f(x_0)}\circ T(C'_{f(x)}fC_x^{-1})\circ T(C_{x_0,x})
  &= T_{C_{x_0}(x)}(C'_{f(x),f(x_0)}C'_{f(x)}fC_x^{-1}C_{x_0,x})\\
  &= T_{C_{x_0}(x)}(C'_{f(x_0)}fC_{x_0})
  \end{align*}
  This is smooth since $C'_{f(x_0)}fC_{x_0}$ is smooth.
\end{proof}

\begin{definition}
\label{def:holonomic_section}
\leanok
\lean{one_jet_sec.is_holonomic_at, one_jet_sec.is_holonomic_at_iff}
\uses{def:one_jet_space}
A section $\F$ of $J^1(M, N) → M$ is called holonomic if it is the
$1$--jet of its base map.
Equivalently, $\F$ is holonomic if there exists
$f \co M → N$ such that $\F = j^1f$, since such a map is
necessarily $\bs \F$.
\end{definition}

\section{First order differential relations}

\begin{definition}
  \label{def:rel}
  \leanok
  \lean{rel_mfld}
  \uses{def:one_jet_space}
  A first order differential relation for maps from $M$ to $N$ is a
  subset $\Rel$ of $J^1(M, N)$.
\end{definition}

\begin{definition}
  \label{def:formal_sol}
  \leanok
  \lean{formal_sol, sol}
  \uses{def:rel, def:one_jet_extension}
  A formal solution of a differential relation $\Rel ⊂ J^1(M, N)$ is a
  section of $J^1(M, N) → M$ taking values in $\Rel$.
  A solution of $\Rel$ is a map from $M$ to $N$ whose $1$--jet extension
  is a formal solution.
\end{definition}


\begin{definition}
  \label{def:htpy_formal_sol}
  \leanok
  \lean{htpy_formal_sol}
  \uses{def:formal_sol}
  A homotopy of formal solutions of $\Rel$ is a family of sections
  $\F : ℝ × M → J^1(M, N)$ which is smooth over $[0, 1] × M$
  and such that each $m ↦ \F(t, m)$ is a formal solution
  when $t$ is in $[0, 1]$.
\end{definition}

The next definition will be used in cases where $X$ and $Y$ are vector spaces,
in order to relate the global theory to the local one.

\begin{definition}
  \label{def:transfer_map}
  \leanok % note: we have not proven continuity/smoothness of ψ yet
  \lean{one_jet_bundle.transfer, one_jet_sec.localize, rel_mfld.localize}
  \uses{def:one_jet_space}
  Given manifolds $M$, $X$, $N$ and $Y$ and smooth open embeddings $g : Y → N$
  and $h : X → M$ we get a transfer map $ψ_{g, h} : J^1(X, Y) → J^1(M, N)$
  defined by
  \[
    ψ_{g, h}(x, y, φ) = (h(x), g(y), T_yg ∘ φ ∘ (T_xh)⁻¹)
  \]
  and an operator on sections which sends $\F : M → J^1(M, N)$ to
  $Ψ_{g, h}\F : X → J^1(X, Y)$ defined when $\bs\F(h(X)) ⊂ g(Y)$ by
  \[
    Ψ_{g, h}\F(x) = (x, g⁻¹ ∘ \bs\F ∘ h(x), (T_{g⁻¹ ∘ \bs\F ∘ h(x)}g)⁻¹ ∘ \F(h(x))_φ ∘ T_xh).
  \]
  Given a relation $\Rel ⊂ J^1(M, N)$, the induced relation in $J^1(X, Y)$
  is $ψ_{g, h}⁻¹\Rel$.
\end{definition}

The following is a localization lemma needed to take advantage of all the work
from the previous chapter.

\begin{lemma}
  \label{lem:transfer}
  \leanok
  \lean{one_jet_sec.localize, is_holonomic_at_localize_iff, one_jet_sec.localize_mem_iff}
  \uses{def:transfer_map, def:holonomic_section, def:formal_sol}
  In the situation of the previous definition, given a section $\F : M → J^1(M, N)$:
  \begin{itemize}
    \item $Ψ_{g, h}(\F)$ is a smooth section of $J^1(X, Y)$.
    \item $\F$ is holonomic on $s ⊂ h(X) ∩ \bs\F⁻¹(g(Y))$ if and only if $Ψ_{g, h}(\F)$
      is holonomic on $h⁻¹(s)$.
    \item $\F$ is a formal solution of $\Rel$ on $h(X) ∩ \bs\F⁻¹(g(Y)$ if and only if $Ψ_{g, h}(\F)$
      is a formal solution of the induced relation $Ψ_{g, h}⁻¹\Rel$.
  \end{itemize}
\end{lemma}

\begin{proof}
  \leanok
  \uses{lem:one_jet_extension_prop}
  The first point is clear by composition. In order to prove the second point
  while keeping notations under control, we set
  $f(x) = g⁻¹ ∘ \bs\F ∘ h$. Using this notation
  $Ψ_{g, h}\F(x) = (x, f(x), (T_{f(x)}g)⁻¹ ∘ \F(h(x))_φ ∘ T_xh)$. We have
  \begin{align*}
    T_x f &= T_{\bs\F ∘ h(x)}(g⁻¹) ∘ T_{h(x)}\bs\F ∘ T_x h\\
          &= \left(T_{f(x)}g\right)⁻¹ ∘ T_{h(x)}\bs\F ∘ T_x h
  \end{align*}
  hence $Ψ_{g, h}\F$ is holonomic at $x$ if and only if
  $\left(T_{f(x)}g\right)⁻¹ ∘ \F(h(x))_φ ∘ T_xh = \left(T_{f(x)}g\right)⁻¹ ∘ T_{h(x)}\bs\F ∘ T_x h$
  and this is equivalent to $\F(h(x))_φ = T_{h(x)}\bs\F$ which is the holonomy condition for
  $\F$ at $h(x)$.

  The third point is a direct consequence of the easy formula $ψ_{g, h} ∘ Ψ_{g, h}(\F) = F ∘ h$.
\end{proof}

\begin{definition}
  \label{def:h-princ}
  \leanok
  \lean{rel_mfld.satisfies_h_principle, rel_mfld.satisfies_h_principle_with}
  \uses{def:htpy_formal_sol}
  A first order differential relation $\Rel ⊂ J^1(M, N)$ satisfies the
  $h$-principle if every formal solution of $\Rel$ is homotopic to a
  holonomic one.
  It satisfies the parametric $h$-principle if, for every manifold with
  boundary $P$, every family $\F : P × M → J^1(M, N)$ of formal
  solutions which are holonomic for $p$ in $𝓝(∂P)$
  is homotopic to a family of holonomic ones relative to $𝓝(∂P)$.
\end{definition}


\subsection*{Parametricity for free}

In many cases, relative parametric $h$-principles can be deduced from relative
non-parametric ones with a larger source manifold.
Let $X$, $P$ and $Y$ be manifolds, with $P$ seen a parameter space.
Denote by $Ψ$ the map from $J^1(X × P, Y)$ to $J^1(X, Y)$ sending $(x, p, y, ψ)$ to
$(x, y, ψ ∘ ι_{x, p})$ where $ι_{x, p} : T_xX → T_xX × T_pP$ sends $v$ to $(v, 0)$.

To any family of sections $F_p : x ↦ (f_p(x), φ_{p, x})$ of $J^1(X, Y)$, we
associate the section $\bar F$ of $J^1(X × P, Y)$ sending $(x, p)$ to
$\bar F(x, p) := (f_p(x), φ_{p, x} ⊕ ∂f/∂p(x, p))$.

\begin{lemma}
  \label{lem:param_trick}
  \uses{def:holonomic_section, def:formal_sol}
  \leanok
  \lean{family_one_jet_sec.is_holonomic_uncurry, family_one_jet_sec.uncurry_mem_iff}
  In the above setup, we have:
  \begin{itemize}
    \item
      $\bar F$ is holonomic at $(x, p)$ if and only if $F_p$ is holonomic
      at $x$.
    \item
      $F$ is a family of formal solutions of some $\Rel ⊂ J^1(X, Y)$ if and
      only if $\bar F$ is a formal solution of $\Rel^P := Ψ^{-1}(\Rel)$.
  \end{itemize}
\end{lemma}

\begin{proof}
  TODO\dots
\end{proof}

\begin{lemma}
  \label{lem:param_for_free}
  \uses{def:h-princ}
  Let $\Rel$ be a first order differential relation for maps from $M$ to
  $N$.
  If, for every manifold with boundary $P$, $\Rel^P$ satisfies the
  $h$-principle then $\Rel$ satisfies the parametric $h$-principle.
  Likewise, the $C^0$-dense and relative $h$-principle for all
  $\Rel^P$ imply the parametric $C^0$-dense and relative $h$-principle for
  $\Rel$.
\end{lemma}

\begin{proof}
  \uses{lem:param_trick}
  This obviously follows from \cref{lem:param_trick}.
\end{proof}


\section{The $h$-principle for open and ample differential relations}
\label{sec:general_theory}

In this chapter, $X$ and $Y$ are smooth manifolds and $\Rel$ is a first order
differential relation on maps from $X$ to $Y$: $\Rel ⊂ J^1(X, Y)$.
For any $σ = (x, y, φ)$ in $\Rel$ and any dual pair
$(λ, v) ∈ T^*_xX × T_xX$,
we set:
\[
    \Rel_{σ, λ, v} =
     \Conn_{φ(v)}\left\{w ∈ T_yY \;;\;
       \big(x,\; y,\; φ + (w - φ(v))⊗λ\big) ∈ \Rel\right\}
\]
where $\Conn_a A$ is the connected component of $A$ containing $a$. In order to
decipher this definition, it suffices to notice that $φ + (w - φ(v))⊗λ$ is the
unique linear map from $T_xX$ to $T_yY$ which coincides with $φ$ on $\ker λ$
and sends $v$ to $w$. In particular, $w = φ(v)$ gives back $φ$.

Of course we will want to deal with more than one point, so we will consider a
vector field $V$ and a $1$--form $λ$ such that $λ(V) = 1$ on some subset $U$ of
$X$, a formal solution $F$ (defined at least on $U$), and get the corresponding
$\Rel_{F, λ, v}$ over $U$.

One easily checks that $\Rel_{σ, κ^{-1}λ, κv} = κ\Rel_{σ, λ, v}$ hence the above
definition only depends on $\ker λ$ and the direction $ℝV$.

\begin{definition}
  \label{def:ample_relation}
  \uses{def:one_jet_space, def:ample_subset}
  \leanok
  \lean{rel_mfld.ample}
  A relation $\Rel$ is ample if, for every $σ = (x, y, φ)$ in $\Rel$ and every
  $(λ, v)$, the slice $\Rel_{σ, λ, v}$ is ample in $T_yY$.
\end{definition}

\begin{lemma}
  \label{lem:ample_iff_loc}
  \uses{def:ample_relation, def:transfer_map}
  \leanok
  \lean{rel_mfld.ample.localize}
  Given manifolds $W$, $X$, $Y$ and $Z$ and smooth open embeddings $g : Z → Y$
  and $h : W → X$, the relation induced (in the sense of \Cref{def:transfer_map})
  in $J^1(W, Z)$ by a ample relation in $J^1(X, Y)$ is ample.
\end{lemma}

\begin{proof}
  \leanok
  By definition, the relation induced by $\Rel$ is
  $ψ_{g, h}⁻¹\Rel$ where
  $ψ_{g, h}(w, z, φ) = (h(w), g(z), T_zg ∘ φ ∘ (T_wh)⁻¹)$.
  Fix $σ =(w, z, φ) ∈ ψ_{g, h}⁻¹\Rel$
  and a dual pair $(λ, v)$ on $T_wW$. We set $G = T_z g$ and $H = T_w h$. Both
  those maps are linear isomorphisms. We compute the slice corresponding to $(σ, λ, v)$:
  \begin{align*}
    ψ_{g, h}⁻¹\Rel(σ, λ, v)
    &= \Conn_{φv}\left\{u ∈ T_wW \;\left|\; (w, z, φ + (u - φv)⊗λ) ∈ ψ_{g, h}⁻¹\Rel \right.\right\}\\
    &= \Conn_{φv}\left\{u ∈ T_wW \;\left|\; (h(w), g(z), G ∘ (φ + (u - φv)⊗λ)∘ H⁻¹) ∈ \Rel \right.\right\}\\
%    &= \left\{u ∈ T_wW \;\left|\; (h(w), g(z), G ∘ φ ∘ H⁻¹ + (Gu - G ∘ φ ∘ H⁻¹ ∘ Hv)⊗(λ ∘ H⁻¹)) ∈ \Rel \right.\right\}\\
%    &= \left\{u ∈ T_wW \;\left|\; (h(w), g(z), G ∘ φ ∘ H⁻¹ + (Gu - G ∘ φ ∘ H⁻¹ ∘ Hv)⊗(λ ∘ H⁻¹)) ∈ \Rel \right.\right\}\\
%    &= \left\{u ∈ T_wW \;\left|\; Gu ∈ \Rel((h(w), g(z), G ∘ φ ∘ H⁻¹), λ ∘ H⁻¹, Gu) \right.\right\}\\
    &= G⁻¹\Rel(ψ_{g, h}σ, λ ∘ H⁻¹, Hv).
  \end{align*}
  Hence the slice $ψ_{g, h}⁻¹\Rel(σ, λ, v)$ is the image of a slice of $\Rel$
  under a linear isomorphism, hence ample.
\end{proof}

\begin{lemma}
  \label{lem:open_ample_immersion}
  \uses{def:ample_relation}
  \leanok
  \lean{immersion_rel_open_ample}
  The relation of immersions of $M$ into $N$ in positive codimension is open
  and ample.
\end{lemma}

\begin{proof}
  \proves{lem:open_ample_immersion}
  \uses{lem:ample_codim_two}
  \lean{immersion_rel_open_ample}
  For every $σ = (x, y, φ)$ in the immersion relation $\Rel$,
  and for every dual pair $(π, v)$, the slice
  $\Rel(σ, π, v)$ is the set of $w$ which do not belong to
  the image of $\ker π$ under $φ$.
  Since $\dim M > \dim N$, this image has codimension at least $2$ in
  $T_yN$, and \cref{lem:ample_codim_two} concludes.
\end{proof}

\begin{theorem}[Gromov]
  \label{thm:open_ample}
  \uses{def:h-princ}
  \leanok
  \lean{rel_mfld.ample.satisfies_h_principle_with}
  If $\Rel$ is open and ample then it satisfies the relative and parametric
  $C^0$-dense $h$-principle.
\end{theorem}

We first explain how to get rid of parameters, using the
relation $\Rel^P$ for families of solutions parametrized by $P$.

\begin{lemma}
    \label{lem:ample_parameter}
    \uses{def:ample_relation}
    If $\Rel$ is ample then, for any parameter space $P$, $\Rel^P$ is also ample.
\end{lemma}

\begin{proof}
  We fix $σ = (x, y, ψ)$ in $\Rel^P$.
  For any $λ = (λ_X, λ_P) ∈ T^*_xX × T^*_pP$ and $v = (v_X, v_P) ∈ T_xX × T_pP$
  such that $λ(v) = 1$, we need to prove that $\Conv\Rel^P_{σ, λ, v} = T_yY$.
  Unfolding the definitions gives:
  \[
  \Rel^P_{σ, λ, v} = \Conn_{φ(v)}\left\{w ∈ T_yY \;;\;
      \big(x,\; y,\; ψ ∘ ι_{x, p} + (w - ψ(v))⊗λ_X\big) ∈ \Rel\right\}.
  \]
  A degenerate but easy case is when $λ_X = 0$. Then the condition on $w$
  becomes $ψ ∘ ι_{x, p} ∈ \Rel$, which is true by definition of $\Rel^P$, so
  $\Rel^P_{σ, λ, v} = T_yY$.

  We now assume $λ_X$ is not zero and choose $u ∈ T_xX$ such that $λ_X(u) = 1$.
  We then have $\Rel^P_{σ, λ, v} = \Rel_{Ψσ, λ_X, u} + ψ(v) - ψ∘ι_{x, p}(u)$.
  Because $\Rel$ is ample and taking convex hull commutes with translation, we
  get that $\Conv\Rel^P_{σ, λ, v} = T_yY$.
\end{proof}

\begin{proof}[Proof of Theorem~\ref{thm:open_ample}]
  \proves{thm:open_ample}
  \uses{lem:param_for_free, lem:ample_parameter, lem:transfer,
  lem:ex_localisation, lem:localisation_stability,
  lem:updating, lem:loc_ultim_const,
  lem:ample_iff_loc, lem:improve_htpy_loc}
  Lemmas~\ref{lem:param_for_free} and~\ref{lem:ample_parameter} prove we can
  assume there are no parameters. So we start with a single formal solution $F$
  of $\Rel$, which is holonomic near some closed subset $A ⊂ X$.

  We apply \cref{lem:ex_localisation}  to get some
  localisation data $(φ \co ι → \set{X}, ψ \co ι' → \set{Y}, j)$ for
  $\bs F : X → Y$. \Cref{lem:localisation_stability} then provides a continuous
  function $ε : X → ℝ_{> 0}$ such that every function $g$ with $d(\bs F, g) < ε$
  sends each $φ_i(E)$ into $ψ_{j(i)}(F)$.
  Since $ι$ is finite or countable we can assume it is a
  convenient indexing set (see \Cref{def:convenient_indexing}). We denote by
  $π \co ℕ → ι$ and $σ \co ι → ℕ$ the corresponding structure maps.

  We will construct by induction on $n$ a sequence of homotopies of sections
  $F_n \co [0, 1] × X → J¹(X, Y)$ such that, for all $n$,
  \begin{itemize}
    \item
      $F_{n, t}(x)$ coincides with $F(x)$ for all $t$ if $n = 0$ or $x$ is
      close to $A$~;
    \item
      for all $t$, $d(\bs F, \bs F_{n, t}) < ε$~;
    \item
      if $π(n+1) = π(n)$ then $F_{n+1, t}$ coincides with $F_{n, t}$ for all $t$~;
    \item
      $F_{n+1, 1}$ is holonomic on $\bigcup_{i < π(n)} φ_i(\bar B_E)$~;
    \item
      each $F_{n+1, t}$ coincides with $F_{n, t}$ outside $φ_{π(n)}(E)$.
  \end{itemize}

  The induction construction starts with setting $F_{0, t} = F$ for all $t$,
  which has the required properties (the first two conditions are clear and the
  other ones don't say anything about $F_0$). Now assume $F_n$ has been constructed.
  If $π(n+1) = π(n)$ then we set $F_{n+1} = F_n$.
  Otherwise we have $π(n+1) > π(n)$.

  For any $t$, since $d(\bs F, \bs F_{n, t}) < ε$ by induction hypothesis,
  $\bs F_{n, t}$ sends $φ_i(E)$ into $ψ_{j(i)}(F)$.

  \Cref{def:transfer_map} then
  turns $F_n$ into a homotopy of sections $\F$ of $J¹(E, F)$.
  According to \Cref{lem:transfer}, each $\F_t$ is a formal solution of
  the relation $\Rel_i$ induced by $\Rel$ in $J¹(E, F)$ via $φ_{π(n)}$ and
  $ψ_{j(π(n))}$, $\F$ is relative to $φ_{π(n)}⁻¹(A)$
  and $\F_1$ is holonomic near $φ_{π(n)}⁻¹(A ∪ \bigcup_{i < π(n)} φ_i(\bar B_E))$.

  The new homotopy $F_{n+1}$ will be constructed by updating $F_n$ using some
  homotopy $\F'$ of sections of $J¹(E, F)$. In order to ensure
  $d(\bs F, \bs F_{n+1}) < ε$, it suffices to ensure that, for each $x$ and $t$,
  either $\F_{n+1, t}(x) = \F_{n, t'}(x)$ for some $t'$ or
  $d(\bs F_{n, 1}(x), \bs F_{n+1, t}(x)) < ε(x) - d(\bs F(x), \bs F_{n, 1}(x))$.
  The latter will hold as soon as, for all $e$ and $t$,
  $‖\bs \F_1(e) - \bs \F'_t(e)‖ < η$ for some positive $η$ given by
  \Cref{lem:updating} (applied to $M × [0, 1]$ and $N$).
  So \Cref{lem:improve_htpy_loc} gives a suitable $\F'$.

  Now that the inductive construction is completed, we apply
  \Cref{lem:loc_ultim_const} to make sure our sequence $F_n$ is locally
  ultimately constant, hence it converges pointwise to a smooth homotopy
  relative to $A$ and ending at a holonomic section of $\Rel$.
\end{proof}

\begin{theorem}[Smale 1958]
  \label{thm:sphere_eversion}
  \lean{sphere_eversion}\leanok
	There is a homotopy of immersions of $𝕊^2$ into $ℝ^3$ from the inclusion map to
	the antipodal map $a : q ↦ -q$.
\end{theorem}

\begin{proof}
  \uses{thm:open_ample, lem:open_ample_immersion}
	We denote by $ι$ the inclusion of $𝕊^2$ into $ℝ^3$.
	We set $j_t = (1-t)ι	+ ta$.
  This is a homotopy from $ι$ to $a$ (but not animmersion for $t=1/2$).
  Using the canonical trivialization of the tangent
	bundle of $ℝ^3$, we can set, for $(q, v) ∈ T𝕊^2$,
	$G_t(q, v) = \mathrm{Rot}_{Oq}^{πt}(v)$, the rotation around axis $Oq$ with
	angle $πt$.
  The family $σ : t ↦ (j_t, G_t)$ is a homotopy of formal immersions
  relating $j^1ι$ to $j^1a$.
  It is homotopic by reparametrization to a homotopy of formal immersions
  relating $j^1ι$ to $j^1a$ which are holonomic for $t$ near the
  $0$ and $1$.

  The above theorem ensures this family is homotopic,
	relative to $t = 0$ and $t = 1$, to a family of holonomic formal immersions,
	ie a family $t ↦ j^1f_t$ with $f_0 = ι$, $f_1 = a$, and each $f_t$ is an
	immersion.
\end{proof}

% vim: set expandtab sw=2 tabstop=2 tw=80:
