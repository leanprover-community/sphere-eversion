\chapter{Local theory of convex integration}
\label{chap:local}
\section{Key construction}
\label{sec:convex_integration_intro}

The goal of this chapter is to explain the local aspects of
(TheilliÃ¨re's implementation of) convex integration, the next chapter will
cover global aspects.

The elementary step of convex integration modifies the derivative of a
map in one direction. The precise meaning of ``one direction'' rely on the
following definition.

\begin{definition}
  \label{def:dual_pair}
  \leanok
  \lean{dual_pair'}
  A dual pair on a vector space $E$ is a pair $(Ï€, v)$ where $Ï€$ is a linear
  form on $E$ and $v$ a vector in $E$ such that $Ï€(v) = 1$.
\end{definition}

Let $E$ and $F$ be finite dimensional real normed vector spaces.
Let $f \co E â†’ F$ be a smooth map, and let $(Ï€, v)$ be a dual pair on $E$.
We want to modify $Df$ in the direction of $v$ while almost preserving it
on $\ker Ï€$.
Say we wish $Df(x)v$ could live in some open subset $Î©_x âŠ‚ F$. Assume there is
a smooth compactly supported family of loops $Î³ \co E Ã— ð•Š^1 â†’ F$ such that each
$Î³_x$ takes values in $Î©_x$, and its average value $\overline{Î³}_x = \int_{ð•Š^1}
Î³_x$ is $Df(x)v$ for all $x$. Obviously such loops can exist
only if $Df(x)v$ is in the convex hull of $Î©_x$, and we saw in the previous
chapter that this is almost sufficient (and we'll see this is sufficiently
almost sufficient for our purposes). Then we can modify $f$ to fulfil our wish
using the following construction.

\begin{definition}
  \label{def:corrugation}
  \leanok
  \lean{corrugation}
  The map obtained by corrugation of $f$ in direction $(Ï€, v)$ using $Î³$
  with oscillation number $N$ is
  \[
    x â†¦ f(x) + \frac1N  âˆ«_0^{NÏ€(x)} \left[Î³_x(s) - \overline{Î³}_x\right]ds.
  \]
\end{definition}

In the above definition, we mostly think of $N$ as a large natural
number.
But we don't actually require it, any positive real number will do.

The next proposition implies that, provided $N$ is large enough, we have
achieved $Df'(x)v âˆˆ Î©_x$, almost without modifying derivatives in the
directions of $\ker Ï€$, and almost without moving $f(x)$.

\begin{proposition}[TheilliÃ¨re 2018]
  \label{prop:theilliere}
  \lean{fderiv_corrugated_map, corrugation.c0_small_on, remainder_c0_small_on, corrugation.support}\leanok
  \uses{def:corrugation,def:loop_family_support}
  Let $f$ be a $\mathcal{C}^1$ function from $E$ to $F$. Let $(Ï€, v)$ be a dual
  pair on $E$. Let $Î³ \co E Ã— ð•Š^1 â†’ F$ be a $\mathcal{C}^1$ family of loops
  such that $\overline{Î³_x} = Df(x)v$ for all $x$.

  For any compact set $K âŠ‚ E$ and any positive $Îµ$, the function $f'$ obtained
  by corrugation of $f$ in direction $(Ï€, v)$ using $Î³$ with large enough
  oscillation number $N$ satisfies:
  \begin{enumerate}
    \item\label{CP:C0}
      $âˆ€ x âˆˆ K, â€–f'(x) - f(x)â€– â‰¤ Îµ$
    \item\label{CP:kerpi}
      $âˆ€ x âˆˆ K, â€–(Df'(x) - Df(x))_{|\ker Ï€}â€– â‰¤ Îµ$.
    \item\label{CP:v}
      $âˆ€ x âˆˆ K, â€–Df'(x)v - Î³(x, NÏ€(x))â€– â‰¤ Îµ$
  \end{enumerate}
  In addition, all the differences estimated above vanish if $x$ is outside the
  support of $Î³$.
\end{proposition}

\begin{proof}
  \leanok
  We set $Î“_x(t) = âˆ«_0^t \left(Î³_x(s) - \overline{Î³}_x\right)ds$, so that
  $f'(x) = f(x) + Î“_x(NÏ€(x))/N$.  Because each $Î“_x$ is $1$-periodic, and
  everything has compact support in $E$, all derivatives of $Î“$ are uniformly
  bounded.  Item~\ref{CP:C0} in the statement is then obvious.
  Item~\ref{CP:kerpi} also follows since
  $âˆ‚_if'(x) = âˆ‚_if(x) + âˆ‚_iÎ“(x, NÏ€(x))/N$. In order to prove
  Item~\ref{CP:v}, we compute:
  \begin{align*}
      Df'(x)v &= Df(x)v + \frac1N âˆ‚_jÎ“(x, NÏ€(x)) + \frac NN âˆ‚_tÎ“(x, NÏ€(x))\\
                       &= Df(x)v + \bigO{\frac1N} + Î³(x, NÏ€(x)) - Df(x)v\\
                       &= Î³(x, NÏ€(x)) + \bigO{\frac1N}.
  \end{align*}
  Outside the support of $Î³$, $Î“_x$ and its derivative with respect to $x$
  vanish identically (for the derivative computation, it is important that the
  support of $Î³$ is the \emph{closure} of the set of $x$ where $Î³_x$ is not
  constant).
\end{proof}

\section{The main inductive step}
\label{sec:inductive_step}

\begin{definition}
  \label{def:hol_partial}
  \leanok
  \lean{rel_loc.formal_sol.is_part_holonomic_at}
  Let $E'$ be a linear subspace of $E$.
  A map $\F = (f, Ï†) : E â†’ F Ã— \Hom(E, F)$ is $E'$--holonomic if,
  for every $v$ in $E'$ and every $x$, $Df(x)v = Ï†(x)v$.
\end{definition}

\begin{definition}
  \label{def:rel_loc}
  \leanok
  \lean{rel_loc}
  A first order differential relation for maps from $E$ to $F$ is a
  subset $\Rel$ of $E Ã— F Ã— \Hom(E, F)$.
\end{definition}

Until the end of this section, $\Rel$ will always denote a first order
differential relation for maps from $E$ to $F$.

\begin{definition}
  \label{def:formal_sol_loc}
  \leanok
  \lean{rel_loc.formal_sol}
  \uses{def:rel_loc}
  A formal solution of a differential relation $\Rel$ is a map
  $\F = (f, Ï†) \co E â†’ F Ã— \Hom(E, F)$ such that, for every $x$,
  $(x, f(x), Ï†(x))$ is in $\Rel$.
\end{definition}

The first component of a map $\F \co E â†’ F Ã— \Hom(E, F)$ will sometimes
be denoted by $\bs \F \co E â†’ F$ and called the base map of $\F$.

\begin{definition}
  \label{def:htpy_jet_sec_loc}
  \leanok
  \lean{htpy_jet_sec}
  A $1$-jet section from $E$ to $F$ is a function from $E$ to $F Ã— \Hom(E, F)$.
  A homotopy of $1$-jet sections is a smooth map
  $\F : â„ Ã— E â†’ F Ã— \Hom(E, F)$.
\end{definition}

Typically, $x â†¦ \F(t, x)$ will be denoted by $\F_t$. It could seem more natural to take
$[0, 1] Ã— E$ as the source of a homotopy but this would be less convenient for
formalization and wouldn't change anything since any map from $â„ Ã— E$ can be restricted to
$[0, 1] Ã— E$ and every map from $[0, 1] Ã— E$ could be extended.

\begin{definition}
  \label{def:rel_slice}
  \leanok
  \lean{rel_loc.slice}
  \uses{def:rel_loc}
  For every $Ïƒ = (x, y, Ï†)$, the slice of $\Rel$ at $Ïƒ$ with respect to $(Ï€, v)$
  is:
  \[
    \Rel(Ïƒ, Ï€, v) = \{w âˆˆ F \;|\; (x, y, Ï† + (w - Ï†(v)) âŠ— Ï€) âˆˆ \Rel\}.
  \]
\end{definition}

\begin{lemma}
  \label{lem:update_lin_map}
  \leanok
  \lean{dual_pair'.update_ker_pi, dual_pair'.update_v, rel_loc.jet_sec.mem_slice}
  The linear map $Ï† + (w - Ï†(v)) âŠ— Ï€)$ coincides with $Ï†$ on $\ker Ï€$
  and sends $v$ to $w$.
  If $\sigma$ belongs to $\Rel$ then $Ï†(v)$ belongs to
  $\{w âˆˆ F, (x, y, Ï† + (w - Ï†(v)) âŠ— Ï€) âˆˆ \Rel\}$.
\end{lemma}

\begin{proof}\leanok
  These are direct checks.
\end{proof}


We'll use the notation $\Conn_w A$ to denote the connected component of $A$
that contains $w$, or the empty set if $w$ doesn't belong to $A$.

\begin{definition}
  \label{def:short_formal_sol}
  \leanok
  \lean{rel_loc.formal_sol.is_short_at}
  \uses{def:formal_sol_loc, def:dual_pair}
  A formal solution $\F$ of $\Rel$ is $(Ï€, v)$--short if,
  for every $x$, $Df(x)v$ belonds to the interior of the convex hull of
  $\Conn_{Ï†(v)}\Rel((x, f(x), Ï†(x)), Ï€, v)$.
\end{definition}

\begin{lemma}
  \label{lem:integration_step}
  \leanok
  \lean{step_landscape.improve_step_rel_t_eq_0, step_landscape.improve_step_rel_C,%
    step_landscape.improve_step_rel_compl_Kâ‚, step_landscape.improve_step_c0_close,%
    step_landscape.improve_step_part_hol}
  \uses{def:formal_sol_loc, def:short_formal_sol, def:hol_partial, def:htpy_jet_sec_loc}
  Let $\F$ be a formal solution of $\Rel$.
  Let $K_1 âŠ‚ E$ be a compact subset, and let $K_0$ be a compact subset of
  the interior of $K_1$. Let $C$ be a closed subset of $E$.
  Let $E'$ be a linear subspace of $E$ contained in $\ker Ï€$.
  Let $Îµ$ be a positive real number.

  Assume $\Rel$ is open.
  Assume that $\F$ is $E'$--holonomic near $K_0$, $(Ï€, v)$--short,
  and holonomic near $C$.
  Then there is a homotopy $\F_t$ such that:
  \begin{enumerate}
    \item
      $\F_0 = \F$~;
    \item
      $\F_t$ is a formal solution of $\Rel$ for all $t$~;
    \item
      $\F_t(x) = \F(x)$ for all $t$ when $x$ is near $C$ or outside
      $K_1$~;
    \item
      $d(\bs\F_t(x), \bs \F(x)) â‰¤ Îµ$ for all $t$ and all $x$~;
    \item
      $\F_1$ is $E' âŠ• â„v$--holonomic near $K_0$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  \leanok
  \proves{lem:integration_step}
  \uses{prop:loops, prop:theilliere, lem:update_lin_map}
  We denote the components of $F$ by $f$ and $Ï†$.
  Since $\F$ is short, \cref{prop:loops} applied to
  $g \co x â†¦ Df(x)v$, $Î² \co x â†¦ Ï†(x)v$,
  $Î©_x = \Rel(\F(x), Ï€, v)$, and $K = C âˆ© K_1$ gives us a smooth family of loops
  $Î³ \co E Ã— [0, 1] Ã— ð•Š^1 â†’ F$ such that, for all $x$:
  \begin{itemize}
    \item $âˆ€ t\, s,\; Î³^t_x(s) âˆˆ \Rel(\F(x), Ï€, v)$
    \item $âˆ€ s,\; Î³^0_x(s) = Ï†(x)v$
    \item $\bar Î³^1_x = Df(x)v$
    \item if $x$ is near $C$, $âˆ€t\, s,\; Î³^t_x(s) = Ï†(x)v$
  \end{itemize}
  Let $Ï: E â†’ â„$ be a smooth cut-off function which equals one on
  a neighborhood of $K_0$ and whose support is contained in $K_1$.

  Let $N$ be a positive real number.
  Let $\bar f$ be the corrugated map constructed from $f$, $Î³^1$ and $N$.
  \Cref{prop:theilliere} ensures that, for all $x$,
  \[
    D\bar f(x) = Df(x) + \left[Î³^1_x(NÏ€(x)) - Df(x)v\right] âŠ— Ï€ +
             \frac1N B_x
  \]
  for some bounded map $B$ which vanishes whenever $Î³_x$ is constant,
  hence vanishes near $C$.

  We set $\F_t(x) = \big(f_t(x), Ï†_t(x)\big)$ where:
  \[
    f_t(x) = f(x) + \frac{tÏ(x)}N \int_0^{NÏ€(x)}
                    \left[Î³^t_x(s) - Df(x)v\right]\, ds
  \]
  and
  \[
    Ï†_t(x) = Ï†(x) + \left[Î³^{tÏ(x)}_x(NÏ€(x)) - Ï†(x)v\right] âŠ— Ï€ +
            \frac{tÏ(x)}N B_x.
  \]

  We now prove that $\F_t$ has the announced properties, starting with
  he obvious ones.
  The fact that $\F_0 = \F$ is obvious since $Î³^0_x(s) = Ï†(x)v$ for all
  $s$.

  When $x$ is near $C$, $Df(x) = Ï†(x)$ since $\F$ is holonomic near
  $C$.
  In addition, $Î³^t_x(s) = Ï†(x)v$ for all $s$ and $t$, hence $B_x$ vanishes.
  Hence $\F_t(x) = \F(x)$ for all $t$ when $x$ is near $C$.

  Outside of $K_1$, $Ï$ vanishes. Hence $f_t(x) = f(x)$ for all $t$,
  and $Î³^{tÏ(x)}_x(s) = Ï†(x)v$ for all $s$ and $t$, and $Ï†_t(x) = Ï†(x)$.

  The distance between $f(x)$ and $f_t(x)$ is zero outside of $K_1$ which
  is compact, and $\bigO{1/N}$, so it is less than $Îµ$ for $N$ large
  enough.

  We now turn to the interesting parts.
  The first one is that each $\F_t$ is a formal solution of $\Rel$.
  We already now that $\F_t$ coincides with $\F$, which is a formal
  solution, outside of the compact set $K_1$.
  We set
  \[
    \F'_t(x) = \left(f(x),
                     Ï†(x) + \left[Î³^{tÏ(x)}_x(NÏ€(x)) - Ï†(x)v\right] âŠ— Ï€\right).
  \]
  Since $\Rel$ is open, and $K_1 Ã— [0, 1]$ is compact and $\F_t$ is
  within $\bigO{1/N}$ of $\F'_t$, it suffices to prove that $\F'_t$ is a formal
  solution for all $t$.
  This is guaranteed by the definition of the slice $\Rel(\F(x), Ï€, v)$
  to which $Î³^{tÏ(x)}_x(NÏ€(x))$ belongs.

  Finally, let's prove that $\F_1$ is $E' âŠ• â„v$--holonomic near $K_0$.
  Since $Ï = 1$ near $K_0$, we have, for $x$ near $K_0$,
  \[
    Df_1(x) = Df(x) + \left[Î³^1_x(NÏ€(x)) - Df(x)v\right] âŠ— Ï€ +
             \frac1N B_x,
  \]
  and
  \[
    Ï†_1(x) = Ï†(x) + \left[Î³^1_x(NÏ€(x)) - Ï†(x)v\right] âŠ— Ï€ +
            \frac{1}N B_x.
  \]
  Let $p$ be the projection of $E$ onto $\ker Ï€$ along $v$,
  so that $\Id_E = p + v âŠ— Ï€$.
  We can rewrite the above formulas as
  \[
    Df_1(x) = Df(x) âˆ˜ p + Î³^1_x(NÏ€(x)) âŠ— Ï€ + \frac1N B_x,
  \]
  and
  \[
    Ï†_1(x) = Ï†(x) âˆ˜ p + Î³^1_x(NÏ€(x)) âŠ— Ï€ + \frac{1}N B_x.
  \]
  So we see the difference is $Df(x) âˆ˜ p - Ï†(x) âˆ˜ p$ which vanishes on
  $E'$ since $\F$ is $E'$--holonomic near $K_0$, and vanishes on $v$ since
  $p(v) = 0$.
\end{proof}

\section{Ample differential relations}
\label{sec:ample_differential_relations}

\begin{definition}
  \label{def:ample_subset}
  \leanok
  \lean{ample_set}
  A subset $Î©$ of a real vector space $E$ is ample if the convex
  hull of each connected component of $Î©$ is the whole $E$.
\end{definition}

\begin{lemma}
  \label{lem:ample_codim_two}
  \uses{def:ample_subset}
  \lean{ample_of_two_le_codim}
  \leanok
  The complement of a linear subspace of codimension at least 2 is
  ample.
\end{lemma}

\begin{proof}
  \leanok
  Let $F$ be subspace of $E$ with codimension at least $2$.
  Let $F'$ be a complement subspace.
  Its dimension is at least $2$ since it is isomorphic to $E/F$
  and $\dim(E/F) = \codim(F) â‰¥ 2$.
  First note the complement of $F$ is path-connected.
  Indeed let $x$ and $y$ be points outside $F$.
  Decomposing on $F âŠ• F'$, we get $x = u + u'$ and $y = v + v'$
  with $u' â‰  0$ and $v' â‰  0$.
  The segments from $x$ to $u'$ and $y$ to $v'$ stay outside $F$,
  so it suffices to connect $u'$ and $v'$ in $F' âˆ– \{0\}$.
  If the segment from $u'$ to $v'$ doesn't contains the origin then we
  are done.
  Otherwise $v' = Î¼u'$ for some (negative) $u'$.
  Since $\dim(F') â‰¥ 2$ and $u' â‰  0$, there exists $f âˆˆ F'$
  which is linearly independent from $u'$, hence from $v'$.
  We can then connect both $u'$ and $v'$ to $f$ by a segment
  away from zero.

  We now turn to ampleness.
  The connectedness result reduces to prove that every $e$ in $E$
  is in the convex hull of $E âˆ– F$.
  If $e$ is not in $F$ then it is the convex combination of itself with
  coefficient $1$ and we are done.
  Now assume $e$ is in $F$.
  The codimension assumption guarantees the existence
  of a subspace $G$ such that $\dim(G) = 2$ and $G âˆ© F = \{0\}$.
  Let $(g_1, g_2)$ be a basis of $G$.
  We set $p_1 = e + g_1$, $p_2 = e + g_2$, $p_3 = e - g_1 - g_2$.
  All these points are in $E âˆ– F$ and $e = p_1/3 + p_2/3 + p_3/3$.
\end{proof}

\begin{definition}
  \label{def:ample_relation_loc}
  \leanok
  \lean{rel_loc.is_ample}
  \uses{def:ample_subset, def:rel_loc, def:rel_slice}
  A first order differential relation $\Rel$ is ample if all its slices
  are ample.
\end{definition}

\begin{lemma}
  \label{lem:open_ample_immersion_loc}
  \uses{def:ample_subset}
  The relation of immersions in positive codimension is open and ample.
\end{lemma}

\begin{proof}
  \uses{lem:ample_codim_two}
  For every $Ïƒ = (x, y, Ï†)$ in the immersion relation $\Rel$,
  and for every dual pair $(Ï€, v)$, the slice
  $\Rel(Ïƒ, Ï€, v)$ is the set of $w$ which do not belong to
  the image of $\ker Ï€$ under $Ï†$.
  Since $\dim F > \dim E$, this image has codimension at least $2$ in
  $F$, and \cref{lem:ample_codim_two} concludes.
\end{proof}

\begin{lemma}
  \label{lem:h_principle_open_ample_loc}
  \leanok
  \lean{rel_loc.formal_sol.improve}
  \uses{def:ample_relation_loc, def:holonomic_loc}
  Let $\F$ be a formal solution of $\Rel$.
  Let $K_1 âŠ‚ E$ be a compact subset, and let $K_0$ be a compact subset of
  the interior of $K_1$.
  Assume $\F$ is holonomic near a subset closed $C$ of $E$.
  Let $Îµ$ be a positive real number.

  If $\Rel$ is open and ample then there is a homotopy $\F_t$ such that:
  \begin{enumerate}
    \item
      $\F_0 = \F$
    \item
      $\F_t$ is a formal solution of $\Rel$ for all $t$~;
    \item
      $\F_t(x) = \F(x)$ for all $t$ when $x$ is near $C$ or outside $K_1$.
    \item
      $d(\bs\F_t(x), \bs \F(x)) â‰¤ Îµ$ for all $t$ and all $x$~;
    \item
      $\F_1$ is holonomic near $K_0$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  \leanok
  \uses{lem:integration_step}
  This is a straightforward induction using \cref{lem:integration_step}.
  Let $(e_1, \dots, e_n)$ be a basis of $E$,
  and let $(Ï€_1, \dots, Ï€_n)$ be the dual basis.
  Let $E'_i$ be the linear subspace of $E$ spanned by
  $(e_1, \dots, e_i)$, for $1 â‰¤ i â‰¤ n$, and let $E'_0$ be the zero
  subspace of $E$.
  Each $(Ï€_i, e_i)$ is a dual pair and the kernel of $Ï€_i$ contains
  $E'_{i - 1}$.

  \Cref{lem:integration_step} allows to build a sequence of homotopies
  of formal solutions,
  each homotopy relating a formal solution which is $E'_i$--holonomic to
  one which is $E'_{i+1}$--holonomic (always near $K_0$).
  The shortness condition is always satisfies because $\Rel$ is
  ample.
  Each homotopy starts where the previous one stopped, stay at
  $C^0$ distance at most $Îµ/n$, and is relative to $C$ and
  the complement of $K_1$.

  It then suffices to do a smooth concatenation of theses homotopies.
  We first pre-compose with a smooth map from $[0, 1]$ to itself that
  fixes $0$ and $1$ and has vanishing derivative to all orders at $0$
  and $1$.
  Then we precompose by affine isomorphisms from $[0, 1]$
  to $[i/n, (i + 1)/n]$ before joining them.
\end{proof}

% vim: set expandtab sw=2 tabstop=2:
