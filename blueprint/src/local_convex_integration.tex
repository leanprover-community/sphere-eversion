\chapter{Local theory of convex integration}
\label{chap:local}
\section{Key construction}
\label{sec:convex_integration_intro}

The goal of this chapter is to explain the local aspects of
(Theillière's implementation of) convex integration, the next chapter will
cover global aspects.

The elementary step of convex integration modifies the derivative of a
map in one direction. The precise meaning of ``one direction'' rely on the
following definition.

\begin{definition}
  \label{def:dual_pair}
  \leanok
  \lean{dual_pair}
  A dual pair on a vector space $E$ is a pair $(π, v)$ where $π$ is a linear
  form on $E$ and $v$ a vector in $E$ such that $π(v) = 1$.
\end{definition}

Let $E$ and $F$ be finite dimensional real normed vector spaces.
Let $f \co E → F$ be a smooth map, and let $(π, v)$ be a dual pair on $E$.
We want to modify $Df$ in the direction of $v$ while almost preserving it
on $\ker π$.
Say we wish $Df(x)v$ could live in some open subset $Ω_x ⊂ F$. Assume there is
a smooth compactly supported family of loops $γ \co E × 𝕊^1 → F$ such that each
$γ_x$ takes values in $Ω_x$, and its average value $\overline{γ}_x = \int_{𝕊^1}
γ_x$ is $Df(x)v$ for all $x$. Obviously such loops can exist
only if $Df(x)v$ is in the convex hull of $Ω_x$, and we saw in the previous
chapter that this is almost sufficient (and we'll see this is sufficiently
almost sufficient for our purposes). Then we can modify $f$ to fulfil our wish
using the following construction.

\begin{definition}
  \label{def:corrugation}
  \leanok
  \lean{corrugation}
  The map obtained by corrugation of $f$ in direction $(π, v)$ using $γ$
  with oscillation number $N$ is
  \[
    x ↦ f(x) + \frac1N  ∫_0^{Nπ(x)} \left[γ_x(s) - \overline{γ}_x\right]ds.
  \]
\end{definition}

In the above definition, we mostly think of $N$ as a large natural
number.
But we don't actually require it, any positive real number will do.

The next proposition implies that, provided $N$ is large enough, we have
achieved $Df'(x)v ∈ Ω_x$, almost without modifying derivatives in the
directions of $\ker π$, and almost without moving $f(x)$.

\begin{proposition}[Theillière 2018]
  \label{prop:theilliere}
  \lean{fderiv_corrugated_map, corrugation.c0_small_on, remainder_c0_small_on, corrugation.support}\leanok
  \uses{def:corrugation,def:loop_family_support}
  Let $f$ be a $\mathcal{C}^1$ function from $E$ to $F$. Let $(π, v)$ be a dual
  pair on $E$. Let $γ \co E × 𝕊^1 → F$ be a $\mathcal{C}^1$ family of loops
  such that $\overline{γ_x} = Df(x)v$ for all $x$.

  For any compact set $K ⊂ E$ and any positive $ε$, the function $f'$ obtained
  by corrugation of $f$ in direction $(π, v)$ using $γ$ with large enough
  oscillation number $N$ satisfies:
  \begin{enumerate}
    \item\label{CP:C0}
      $∀ x ∈ K, ‖f'(x) - f(x)‖ ≤ ε$
    \item\label{CP:kerpi}
      $∀ x ∈ K, ‖(Df'(x) - Df(x))_{|\ker π}‖ ≤ ε$.
    \item\label{CP:v}
      $∀ x ∈ K, ‖Df'(x)v - γ(x, Nπ(x))‖ ≤ ε$
  \end{enumerate}
  In addition, all the differences estimated above vanish if $x$ is outside the
  support of $γ$.
\end{proposition}

\begin{proof}
  \leanok
  We set $Γ_x(t) = ∫_0^t \left(γ_x(s) - \overline{γ}_x\right)ds$, so that
  $f'(x) = f(x) + Γ_x(Nπ(x))/N$.  Because each $Γ_x$ is $1$-periodic, and
  everything has compact support in $E$, all derivatives of $Γ$ are uniformly
  bounded.  Item~\ref{CP:C0} in the statement is then obvious.
  Item~\ref{CP:kerpi} also follows since
  $∂_if'(x) = ∂_if(x) + ∂_iΓ(x, Nπ(x))/N$. In order to prove
  Item~\ref{CP:v}, we compute:
  \begin{align*}
      Df'(x)v &= Df(x)v + \frac1N ∂_jΓ(x, Nπ(x)) + \frac NN ∂_tΓ(x, Nπ(x))\\
                       &= Df(x)v + \bigO{\frac1N} + γ(x, Nπ(x)) - Df(x)v\\
                       &= γ(x, Nπ(x)) + \bigO{\frac1N}.
  \end{align*}
  Outside the support of $γ$, $Γ_x$ and its derivative with respect to $x$
  vanish identically (for the derivative computation, it is important that the
  support of $γ$ is the \emph{closure} of the set of $x$ where $γ_x$ is not
  constant).
\end{proof}

\section{The main inductive step}
\label{sec:inductive_step}

\begin{definition}
  \label{def:hol_partial}
  \leanok
  \lean{rel_loc.formal_sol.is_part_holonomic_at}
  Let $E'$ be a linear subspace of $E$.
  A map $\F = (f, φ) : E → F × \Hom(E, F)$ is $E'$--holonomic if,
  for every $v$ in $E'$ and every $x$, $Df(x)v = φ(x)v$.
\end{definition}

\begin{definition}
  \label{def:rel_loc}
  \leanok
  \lean{rel_loc}
  A first order differential relation for maps from $E$ to $F$ is a
  subset $\Rel$ of $E × F × \Hom(E, F)$.
\end{definition}

Until the end of this section, $\Rel$ will always denote a first order
differential relation for maps from $E$ to $F$.

\begin{definition}
  \label{def:formal_sol_loc}
  \leanok
  \lean{rel_loc.formal_sol}
  \uses{def:rel_loc}
  A formal solution of a differential relation $\Rel$ is a map
  $\F = (f, φ) \co E → F × \Hom(E, F)$ such that, for every $x$,
  $(x, f(x), φ(x))$ is in $\Rel$.
\end{definition}

The first component of a map $\F \co E → F × \Hom(E, F)$ will sometimes
be denoted by $\bs \F \co E → F$ and called the base map of $\F$.

\begin{definition}
  \label{def:htpy_jet_sec_loc}
  \leanok
  \lean{htpy_jet_sec}
  A $1$-jet section from $E$ to $F$ is a function from $E$ to $F × \Hom(E, F)$.
  A homotopy of $1$-jet sections is a smooth map
  $\F : ℝ × E → F × \Hom(E, F)$.
\end{definition}

Typically, $x ↦ \F(t, x)$ will be denoted by $\F_t$. It could seem more natural to take
$[0, 1] × E$ as the source of a homotopy but this would be less convenient for
formalization and wouldn't change anything since any map from $ℝ × E$ can be restricted to
$[0, 1] × E$ and every map from $[0, 1] × E$ could be extended.

\begin{definition}
  \label{def:rel_slice}
  \leanok
  \lean{rel_loc.slice}
  \uses{def:rel_loc}
  For every $σ = (x, y, φ)$, the slice of $\Rel$ at $σ$ with respect to $(π, v)$
  is:
  \[
    \Rel(σ, π, v) = \{w ∈ F \;|\; (x, y, φ + (w - φ(v)) ⊗ π) ∈ \Rel\}.
  \]
\end{definition}

\begin{lemma}
  \label{lem:update_lin_map}
  \leanok
  \lean{dual_pair.update_ker_pi, dual_pair.update_v, rel_loc.formal_sol.mem_slice}
  The linear map $φ + (w - φ(v)) ⊗ π)$ coincides with $φ$ on $\ker π$
  and sends $v$ to $w$.
  If $\sigma$ belongs to $\Rel$ then $φ(v)$ belongs to
  $\{w ∈ F, (x, y, φ + (w - φ(v)) ⊗ π) ∈ \Rel\}$.
\end{lemma}

\begin{proof}\leanok
  These are direct checks.
\end{proof}


We'll use the notation $\Conn_w A$ to denote the connected component of $A$
that contains $w$, or the empty set if $w$ doesn't belong to $A$.

\begin{definition}
  \label{def:short_formal_sol}
  \leanok
  \lean{rel_loc.formal_sol.is_short_at}
  \uses{def:formal_sol_loc, def:dual_pair}
  A formal solution $\F$ of $\Rel$ is $(π, v)$--short if,
  for every $x$, $Df(x)v$ belongs to the interior of the convex hull of
  $\Conn_{φ(v)}\Rel((x, f(x), φ(x)), π, v)$.
\end{definition}

\begin{lemma}
  \label{lem:integration_step}
  \leanok
  \lean{step_landscape.improve_step_rel_t_eq_0, step_landscape.improve_step_rel_C,%
    step_landscape.improve_step_rel_compl_K₁, step_landscape.improve_step_c0_close,%
    step_landscape.improve_step_part_hol}
  \uses{def:formal_sol_loc, def:short_formal_sol, def:hol_partial, def:htpy_jet_sec_loc}
  Let $\F$ be a formal solution of $\Rel$.
  Let $K_1 ⊂ E$ be a compact subset, and let $K_0$ be a compact subset of
  the interior of $K_1$. Let $C$ be a closed subset of $E$.
  Let $E'$ be a linear subspace of $E$ contained in $\ker π$.
  Let $ε$ be a positive real number.

  Assume $\Rel$ is open.
  Assume that $\F$ is $E'$--holonomic near $K_0$, $(π, v)$--short,
  and holonomic near $C$.
  Then there is a homotopy $\F_t$ such that:
  \begin{enumerate}
    \item
      $\F_0 = \F$~;
    \item
      $\F_t$ is a formal solution of $\Rel$ for all $t$~;
    \item
      $\F_t(x) = \F(x)$ for all $t$ when $x$ is near $C$ or outside
      $K_1$~;
    \item
      $d(\bs\F_t(x), \bs \F(x)) ≤ ε$ for all $t$ and all $x$~;
    \item
      $\F_1$ is $E' ⊕ ℝv$--holonomic near $K_0$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  \leanok
  \proves{lem:integration_step}
  \uses{prop:loops, prop:theilliere, lem:update_lin_map}
  We denote the components of $\F$ by $f$ and $φ$.
  Since $\F$ is short, \cref{prop:loops} applied to
  $g \co x ↦ Df(x)v$, $β \co x ↦ φ(x)v$,
  $Ω_x = \Rel(\F(x), π, v)$, and $K = C ∩ K_1$ gives us a smooth family of loops
  $γ \co E × [0, 1] × 𝕊^1 → F$ such that, for all $x$:
  \begin{itemize}
    \item $∀ t\, s,\; γ^t_x(s) ∈ \Rel(\F(x), π, v)$
    \item $∀ s,\; γ^0_x(s) = φ(x)v$
    \item $\bar γ^1_x = Df(x)v$
    \item if $x$ is near $C$, $∀t\, s,\; γ^t_x(s) = φ(x)v$
  \end{itemize}
  Let $ρ: E → ℝ$ be a smooth cut-off function which equals one on
  a neighborhood of $K_0$ and whose support is contained in $K_1$.

  Let $N$ be a positive real number.
  Let $\bar f$ be the corrugated map constructed from $f$, $γ^1$ and $N$.
  \Cref{prop:theilliere} ensures that, for all $x$,
  \[
    D\bar f(x) = Df(x) + \left[γ^1_x(Nπ(x)) - Df(x)v\right] ⊗ π +
             \frac1N B_x
  \]
  for some bounded map $B$ which vanishes whenever $γ_x$ is constant,
  hence vanishes near $C$.

  We set $\F_t(x) = \big(f_t(x), φ_t(x)\big)$ where:
  \[
    f_t(x) = f(x) + \frac{tρ(x)}N \int_0^{Nπ(x)}
                    \left[γ^t_x(s) - Df(x)v\right]\, ds
  \]
  and
  \[
    φ_t(x) = φ(x) + \left[γ^{tρ(x)}_x(Nπ(x)) - φ(x)v\right] ⊗ π +
            \frac{tρ(x)}N B_x.
  \]

  We now prove that $\F_t$ has the announced properties, starting with
  he obvious ones.
  The fact that $\F_0 = \F$ is obvious since $γ^0_x(s) = φ(x)v$ for all
  $s$.

  When $x$ is near $C$, $Df(x) = φ(x)$ since $\F$ is holonomic near
  $C$.
  In addition, $γ^t_x(s) = φ(x)v$ for all $s$ and $t$, hence $B_x$ vanishes.
  Hence $\F_t(x) = \F(x)$ for all $t$ when $x$ is near $C$.

  Outside of $K_1$, $ρ$ vanishes. Hence $f_t(x) = f(x)$ for all $t$,
  and $γ^{tρ(x)}_x(s) = φ(x)v$ for all $s$ and $t$, and $φ_t(x) = φ(x)$.

  The distance between $f(x)$ and $f_t(x)$ is zero outside of $K_1$ which
  is compact, and $\bigO{1/N}$, so it is less than $ε$ for $N$ large
  enough.

  We now turn to the interesting parts.
  The first one is that each $\F_t$ is a formal solution of $\Rel$.
  We already now that $\F_t$ coincides with $\F$, which is a formal
  solution, outside of the compact set $K_1$.
  We set
  \[
    \F'_t(x) = \left(f(x),
                     φ(x) + \left[γ^{tρ(x)}_x(Nπ(x)) - φ(x)v\right] ⊗ π\right).
  \]
  Since $\Rel$ is open, and $K_1 × [0, 1]$ is compact and $\F_t$ is
  within $\bigO{1/N}$ of $\F'_t$, it suffices to prove that $\F'_t$ is a formal
  solution for all $t$.
  This is guaranteed by the definition of the slice $\Rel(\F(x), π, v)$
  to which $γ^{tρ(x)}_x(Nπ(x))$ belongs.

  Finally, let's prove that $\F_1$ is $E' ⊕ ℝv$--holonomic near $K_0$.
  Since $ρ = 1$ near $K_0$, we have, for $x$ near $K_0$,
  \[
    Df_1(x) = Df(x) + \left[γ^1_x(Nπ(x)) - Df(x)v\right] ⊗ π +
             \frac1N B_x,
  \]
  and
  \[
    φ_1(x) = φ(x) + \left[γ^1_x(Nπ(x)) - φ(x)v\right] ⊗ π +
            \frac{1}N B_x.
  \]
  Let $p$ be the projection of $E$ onto $\ker π$ along $v$,
  so that $\Id_E = p + v ⊗ π$.
  We can rewrite the above formulas as
  \[
    Df_1(x) = Df(x) ∘ p + γ^1_x(Nπ(x)) ⊗ π + \frac1N B_x,
  \]
  and
  \[
    φ_1(x) = φ(x) ∘ p + γ^1_x(Nπ(x)) ⊗ π + \frac{1}N B_x.
  \]
  So we see the difference is $Df(x) ∘ p - φ(x) ∘ p$ which vanishes on
  $E'$ since $\F$ is $E'$--holonomic near $K_0$, and vanishes on $v$ since
  $p(v) = 0$.
\end{proof}

\section{Ample differential relations}
\label{sec:ample_differential_relations}

\begin{definition}
  \label{def:ample_subset}
  \leanok
  \lean{ample_set}
  A subset $Ω$ of a real vector space $E$ is ample if the convex
  hull of each connected component of $Ω$ is the whole $E$.
\end{definition}

\begin{lemma}
  \label{lem:ample_codim_two}
  \uses{def:ample_subset}
  \lean{ample_of_two_le_codim}
  \leanok
  The complement of a linear subspace of codimension at least 2 is
  ample.
\end{lemma}

\begin{proof}
  \leanok
  Let $F$ be subspace of $E$ with codimension at least $2$.
  Let $F'$ be a complement subspace.
  Its dimension is at least $2$ since it is isomorphic to $E/F$
  and $\dim(E/F) = \codim(F) ≥ 2$.
  First note the complement of $F$ is path-connected.
  Indeed let $x$ and $y$ be points outside $F$.
  Decomposing on $F ⊕ F'$, we get $x = u + u'$ and $y = v + v'$
  with $u' ≠ 0$ and $v' ≠ 0$.
  The segments from $x$ to $u'$ and $y$ to $v'$ stay outside $F$,
  so it suffices to connect $u'$ and $v'$ in $F' ∖ \{0\}$.
  If the segment from $u'$ to $v'$ doesn't contains the origin then we
  are done.
  Otherwise $v' = μu'$ for some (negative) $u'$.
  Since $\dim(F') ≥ 2$ and $u' ≠ 0$, there exists $f ∈ F'$
  which is linearly independent from $u'$, hence from $v'$.
  We can then connect both $u'$ and $v'$ to $f$ by a segment
  away from zero.

  We now turn to ampleness.
  The connectedness result reduces to prove that every $e$ in $E$
  is in the convex hull of $E ∖ F$.
  If $e$ is not in $F$ then it is the convex combination of itself with
  coefficient $1$ and we are done.
  Now assume $e$ is in $F$.
  The codimension assumption guarantees the existence
  of a subspace $G$ such that $\dim(G) = 2$ and $G ∩ F = \{0\}$.
  Let $(g_1, g_2)$ be a basis of $G$.
  We set $p_1 = e + g_1$, $p_2 = e + g_2$, $p_3 = e - g_1 - g_2$.
  All these points are in $E ∖ F$ and $e = p_1/3 + p_2/3 + p_3/3$.
\end{proof}

\begin{definition}
  \label{def:ample_relation_loc}
  \leanok
  \lean{rel_loc.is_ample}
  \uses{def:ample_subset, def:rel_loc, def:rel_slice}
  A first order differential relation $\Rel$ is ample if all its slices
  are ample.
\end{definition}

\begin{lemma}
  \label{lem:h_principle_open_ample_loc}
  \leanok
  \lean{rel_loc.formal_sol.improve}
  \uses{def:ample_relation_loc, def:holonomic_loc}
  Let $\F$ be a formal solution of $\Rel$.
  Let $K_1 ⊂ E$ be a compact subset, and let $K_0$ be a compact subset of
  the interior of $K_1$.
  Assume $\F$ is holonomic near a closed subset $C$ of $E$.
  Let $ε$ be a positive real number.

  If $\Rel$ is open and ample then there is a homotopy $\F_t$ such that:
  \begin{enumerate}
    \item
      $\F_0 = \F$
    \item
      $\F_t$ is a formal solution of $\Rel$ for all $t$~;
    \item
      $\F_t(x) = \F(x)$ for all $t$ when $x$ is near $C$ or outside $K_1$.
    \item
      $d(\bs\F_t(x), \bs \F(x)) ≤ ε$ for all $t$ and all $x$~;
    \item
      $\F_1$ is holonomic near $K_0$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  \leanok
  \uses{lem:integration_step}
  This is a straightforward induction using \cref{lem:integration_step}.
  Let $(e_1, \dots, e_n)$ be a basis of $E$,
  and let $(π_1, \dots, π_n)$ be the dual basis.
  Let $E'_i$ be the linear subspace of $E$ spanned by
  $(e_1, \dots, e_i)$, for $1 ≤ i ≤ n$, and let $E'_0$ be the zero
  subspace of $E$.
  Each $(π_i, e_i)$ is a dual pair and the kernel of $π_i$ contains
  $E'_{i - 1}$.

  \Cref{lem:integration_step} allows to build a sequence of homotopies
  of formal solutions,
  each homotopy relating a formal solution which is $E'_i$--holonomic to
  one which is $E'_{i+1}$--holonomic (always near $K_0$).
  The shortness condition is always satisfies because $\Rel$ is
  ample.
  Each homotopy starts where the previous one stopped, stay at
  $C^0$ distance at most $ε/n$, and is relative to $C$ and
  the complement of $K_1$.

  It then suffices to do a smooth concatenation of theses homotopies.
  We first pre-compose with a smooth map from $[0, 1]$ to itself that
  fixes $0$ and $1$ and has vanishing derivative to all orders at $0$
  and $1$.
  Then we precompose by affine isomorphisms from $[0, 1]$
  to $[i/n, (i + 1)/n]$ before joining them.
\end{proof}

\section{Parametricity for free}%
\label{sec:parametricity_for_free}

In many cases, relative parametric $h$-principles can be deduced from relative
non-parametric ones with a larger source.
Let $E$, $P$ and $F$ be real normed vector spaces, with $P$ seen a parameter space.
Denote by $Ψ$ the map from $J^1(E × P, F)$ to $J^1(E, F)$ sending $(x, p, y, ψ)$ to
$(x, y, ψ ∘ ι_{x, p})$ where $ι_{x, p} : E → E × P$ sends $v$ to $(v, 0)$.

To any family of sections $F_p : x ↦ (f_p(x), φ_{p, x})$ of $J^1(E, F)$, we
associate the section $\bar F$ of $J^1(E × P, F)$ sending $(x, p)$ to
$\bar F(x, p) := (f_p(x), φ_{p, x} ⊕ ∂f/∂p(x, p))$.

\begin{lemma}
  \label{lem:param_trick}
  \uses{def:holonomic_section, def:formal_sol}
  \leanok
  \lean{family_jet_sec.is_holonomic_at_uncurry, family_jet_sec.uncurry_mem_relativize, rel_loc.is_ample.relativize}
  In the above setup, we have:
  \begin{itemize}
    \item
      $\bar F$ is holonomic at $(x, p)$ if and only if $F_p$ is holonomic
      at $x$.
    \item
      $F$ is a family of formal solutions of some $\Rel ⊂ J^1(E, F)$ if and
      only if $\bar F$ is a formal solution of $\Rel^P := Ψ^{-1}(\Rel)$.

    \item If $\Rel$ is ample then, for any parameter space $P$, $\Rel^P$ is also ample.
  \end{itemize}
\end{lemma}

\begin{proof}
  \leanok
  For the first part, the derivative of $\bar F$ is $∂f/∂x(x, p) ⊕ ∂f/∂p(x, p)$, which is equal to
  $\bar F_φ$ iff $∂f/∂x(x, p) = f_φ$.

  The second part follows from $Ψ ∘ \bar F(x,p)=F_p(x)$.

  Now assume $\Rel$ is ample. We fix $σ = (x, y, ψ)$ in $\Rel^P$.
  For any $λ = (λ_E, λ_P) ∈ E^* × P^*$ and $v = (v_E, v_P) ∈ E × P$
  such that $λ(v) = 1$, we need to prove that $\Conv\Rel^P_{σ, λ, v} = F$.
  Unfolding the definitions gives:
  \[
  \Rel^P_{σ, λ, v} = \Conn_{φ(v)}\left\{w ∈ F \;;\;
      \big(x,\; y,\; ψ ∘ ι_{x, p} + (w - ψ(v))⊗λ_E\big) ∈ \Rel\right\}.
  \]
  A degenerate but easy case is when $λ_E = 0$. Then the condition on $w$
  becomes $ψ ∘ ι_{x, p} ∈ \Rel$, which is true by definition of $\Rel^P$, so
  $\Rel^P_{σ, λ, v} = F$.

  We now assume $λ_E$ is not zero and choose $u ∈ E$ such that $λ_E(u) = 1$.
  We then have $\Rel^P_{σ, λ, v} = \Rel_{Ψσ, λ_E, u} + ψ(v) - ψ∘ι_{x, p}(u)$.
  Because $\Rel$ is ample and taking convex hull commutes with translation, we
  get that $\Conv\Rel^P_{σ, λ, v} = F$.
\end{proof}

\section{Application to Smale's theorem}%
\label{sec:application_to_smale_s_theorem}

The local theory of this chapter is already enough to deduce Smale's sphere
eversion theorem. In this section $E$ denote a finite dimensional real vector space
equipped with an inner product. Later we will assume it is 3-dimensional.
We denote by $𝕊$ the unit sphere in $E$.

Although we want to study immersions of $𝕊$ into $E$, we want to work only with
functions defined on the whole $E$. So we introduce a slightly artificial relation.
We denote by $B$ the open ball with radius $9/10$ around the origin in $E$.

\[
  \Rel := \{(x, y, φ) ∈ J^1(E, E) \;|\; x ∉ B ⇒ \rst{φ}{x^⊥} \text{ is injective}\}.
\]

Of course solutions of this relation restrict to immersions of $𝕊$.

\begin{lemma}
  \label{lem:loc_immersion_rel_open}
  \lean{loc_immersion_rel_open}
  \leanok
  The relation $\Rel$ above is open.
\end{lemma}

\begin{proof}
  \leanok
  The main task is to fix $x_0 \notin B$
  and $\varphi_0 \in L(E, E)$ which is injective on $x_0^\perp$ and prove that,
  for every $x$ close to $x_0$ and $\varphi$ close to $\varphi_0$, $\varphi$ is
  injective on $x^\perp$. This is a typical situation where geometric intuition
  makes it feel like there is nothing to prove.

  One difficulty is that the subspace $x^\perp$ moves with $x$. We reduce to a fixed
  subspace by considering the restriction to $x_0^\perp$ of the orthogonal
  projection onto $x^\perp$. One can check this is an isomorphism as long as $x$
  is not perpendicular to $x_0$.
  More precisely, we consider $f \co J^1(E, E) \to ℝ \times L(x_0^\perp, E)$ which sends
  $(x, y, \varphi)$ to $(\langle x_0, x\rangle, \varphi \circ \pr_{x^\perp} \circ j_0)$
  where $j_0$ is the inclusion of $x_0^\perp$ into $E$. The set $U$ of injective
  linear maps is open in $L(x_0^\perp, E)$ and the map $f$ is continuous
  hence the preimage of $\{0\}^c \times U$ is open. This is good enough for us because
  injectivity of $\varphi \circ \pr_{x^\perp} \circ j_0$ implies injectivity of
  $\varphi$ on the image of $\pr_{x^\perp} \circ j_0$ which is $x^\perp$ whenever
  $\langle  x_0, x\rangle \neq 0$.
\end{proof}

\begin{lemma}
  \label{lem:loc_immersion_rel_ample}
  \lean{loc_immersion_rel_ample}
  \leanok
  The relation $\Rel$ above is ample.
\end{lemma}

\begin{proof}
  \leanok
  The core fact here is that if one fixes vector spaces $F$ and $F'$, a dual
  pair $(\pi, v)$ on $F$ and an injective linear map $\varphi \co F \to F'$
  then the updated map $\Upd{p}{\varphi}{w}$ is injective if and only if $w$
  is not in $\varphi(\ker\pi)$. First we assume $\Upd{p}{\varphi}{\varphi(u)}$
  is injective for some $u$ in $\varphi(\ker\pi)$ and derive a contradiction.
  We have $\Upd{p}{\varphi}{\varphi(u)}v = \varphi(u)$ by the general
  definition of updating and also $\Upd{p}{\varphi}{\varphi(u)}u = \varphi(u)$
  since $u$ is in $\ker \pi$. Hence injectivity of $\varphi$ ensure $u = v$,
  which is absurd since $\pi(u) = 0$ and $\pi(v) = 1$. Conversely assume $w$
  is not in $\varphi(\ker\pi)$ and let us prove $\Upd{p}{\varphi}{w}$ is
  injective. Assume $x$ is in the kernel of $\Upd{p}{\varphi}{w}$. Decompose
  $x = u + tv$ with $u \in \ker\pi$ and $t$ a real number. We have
  $\Upd{p}{\varphi}{w}(x) = \varphi(u) + tw$. Hence our assumption on $x$
  implies $t$ vanishes otherwise we would have $w = -t⁻¹\varphi(u)$
  contradicting that $w$ isn't in $\varphi(\ker\pi)$. This vanishing and the
  assumption on $x$ then imply $\varphi(u) = 0$. Since $\varphi$ is injective
  we conclude that $u = 0$ and finally $x = 0$.

  We now turn to $\Rel$. It suffices to prove that for every $\sigma = (x, y,
  \varphi) \in \Rel$ and every dual pair $p = (\pi, v)$ on $E$, the slice
  $\Rel(\sigma, p)$ is ample. If $x$ is in $B$ then $\Rel(\sigma, p)$ is the
  whole $E$ which is obviously ample. So we assume $x$ is not in $B$. Since
  $\sigma$ is in $\Rel$, $\varphi$ is injective on $x^\perp$. The slice is the
  set of $w$ such that $\Upd{p}{\varphi}{w}$ is injective on $x^\perp$. Assume
  first $\ker\pi = x^\perp$. Then $\Upd{p}{\varphi}{w}$ coincides with
  $\varphi$ on $x^\perp$ hence the slice is the whole $E$. Assume now that
  $\ker\pi \neq x^\perp$. The slice is not very easy to picture in this case.
  But one should remember that, up to affine isomorphism, the slice depends
  only on $\ker \pi$. More specifically, if we keep $\pi$ but change $v$ then
  the slice is simply translated in $E$. Here we replace $v$ by the projection
  on $x^\perp$ of the vector dual to $\pi$ rescaled to keep the property
  $\pi(v) = 1$. What has been gained is that we now have $v \in x^\perp$ and
  $x^\perp = (x^\perp \cap \ker \pi) \oplus ℝ v$. Since $\varphi$ is
  injective on $x^\perp$, $\varphi(x^\perp \cap \ker \pi)$ is a hyperplane
  in $x^\perp$ and $\Upd{p}{\varphi}{w}$ is injective on $x^\perp$ if and only
  if $w$ is in the complement of $\varphi(x^\perp \cap \ker \pi)$ according to
  the core fact above. Since it is an hyperplane in $x^\perp$, it has
  codimension at least $2$ in $E$ hence its complement is ample.
\end{proof}

\begin{theorem}[Smale 1958]
  \label{thm:sphere_eversion}
  \lean{sphere_eversion_of_loc}
  \leanok
  There is a homotopy of immersion of $𝕊^2$ into $ℝ^3$ from the inclusion map to
	the antipodal map $a \co q ↦ -q$.
\end{theorem}

\begin{proof}
  \uses{lem:loc_immersion_rel_open, lem:loc_immersion_rel_ample, lem:h_principle_open_ample_loc, lem:param_trick}
	We denote by $ι$ the inclusion of $𝕊^2$ into $ℝ^3$.
	We set $j_t = (1-t)ι	+ ta$.
  This is a homotopy from $ι$ to $a$ (but not an immersion for $t=1/2$).
  Using the canonical trivialization of the tangent
	bundle of $ℝ^3$, we can set, for $(q, v) ∈ T𝕊^2$,
	$G_t(q, v) = \mathrm{Rot}_{Oq}^{πt}(v)$, the rotation around axis $Oq$ with
	angle $πt$.
  The family $σ : t ↦ (j_t, G_t)$ is a homotopy of formal immersions
  relating $j^1ι$ to $j^1a$. Those formal solutions are holonomic when $t$ is
  zero or one, so we can reparametrize the family to make such it is holonomic
  when $t$ is close to zero or one. Then we can extend it to a homotopy of
  formal solutions of $\Rel$ using a suitable cut-off ensuring smoothness
  near the orign. The relation $\Rel$ is ample according to
  \Cref{lem:loc_immersion_rel_ample} and then \Cref{lem:param_trick} ensures
  its 1-parameter version $\Rel^ℝ$ is also ample. The relation $\Rel$ is open according to
  \Cref{lem:loc_immersion_rel_open} hence $\Rel^ℝ$ is also ample.
  So we can use \Cref{lem:h_principle_open_ample_loc} to deform our family of
  formal solutions into a holonomic one.
\end{proof}

% vim: set expandtab sw=2 tabstop=2:
